<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Biểu đồ Lượng Mưa</title>
  <link rel="stylesheet" href="/assets/css/common.css">
  <style>
    .panel{background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:16px;border:1px solid rgba(0,0,0,0.06)}
    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .filters input,.filters select{height:34px;padding:0 10px;border:1px solid #dcdcdc;border-radius:10px;background:#fff}
    .filters button{height:34px;padding:0 14px;border:none;border-radius:10px;background:#2ecc71;color:#fff;font-weight:600;cursor:pointer}
    /* Kéo giãn biểu đồ bằng chiều rộng 100% và chiều cao gần bằng màn hình */
    .chart-wrap{position:relative;width:100%;height:calc(100vh - 220px);min-height:360px}
    #rainChart{position:absolute;inset:0;width:100% !important;height:100% !important}
  </style>
</head>
<body>
  <div class="app">
    <div id="sidebar"></div>
    <main class="main-column">
      <div id="topbar"></div>
      <div class="dashboard">
        <div class="panel">
          <div class="page-title">Biểu đồ Lượng Mưa</div>
          <div style="display:flex;gap:8px;align-items:center;margin:8px 0 14px 0">
            <label for="rainThreshold">Ngưỡng mưa (mm):</label>
            <input id="rainThreshold" type="number" min="0" step="1" value="100" style="height:32px;padding:0 10px;border:1px solid #dcdcdc;border-radius:8px" />
            <button id="btnSetThreshold" style="height:32px;padding:0 12px;border:none;border-radius:8px;background:#4d3ce7;color:#fff;font-weight:600">Lưu ngưỡng</button>
            <span id="saveMsg" style="margin-left:8px;color:#2ecc71;display:none">Đã lưu</span>
          </div>
          <div class="chart-wrap">
            <canvas id="rainChart"></canvas>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="/assets/js/component-loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const API_BASE = `${location.origin}/api`;
    const DEVICE_ID = 'esp32-001';
    const HISTORY_LIMIT = 50;
    
    function getToken(){return localStorage.getItem('apiToken')||''}
    
    // ... (Giữ nguyên hàm fetchRain24h, formatTime, renderChart, load) ...
    async function fetchRain24h(){
      const qs = new URLSearchParams();
      qs.set('deviceId', DEVICE_ID);
      qs.set('limit', HISTORY_LIMIT);
      const res = await fetch(`${API_BASE}/telemetry?${qs.toString()}`,{headers:{'x-api-token':getToken()}});
      if(!res.ok){throw new Error('HTTP '+res.status)}
      return res.json();
    }

    function formatTime(timestamp){
      if(!timestamp) return '';
      const d = new Date(timestamp);
      const vietnamTime = new Date(d.getTime() + (7 * 60 * 60 * 1000));
      return `${vietnamTime.getHours().toString().padStart(2,'0')}:${vietnamTime.getMinutes().toString().padStart(2,'0')}:${vietnamTime.getSeconds().toString().padStart(2,'0')}`;
    }

    let chart;
    function renderChart(rows){
      const ctx = document.getElementById('rainChart').getContext('2d');
      const labels = rows.map(r => formatTime(r.createdAt || r.created_at));
      const data = rows.map(r => Number(r.rain || r.rain_mm || 0));
      const ds = {
        label:'Lượng mưa (mm)', 
        data, 
        borderColor:'#4dadea',
        backgroundColor:'rgba(77, 173, 234, 0.1)',
        borderWidth:3,
        tension:0.4,
        fill:true,
        pointBackgroundColor:'#4dadea',
        pointBorderColor:'#fff',
        pointBorderWidth:2,
        pointRadius:4,
        pointHoverRadius:6,
        pointHoverBackgroundColor:'#4dadea',
        pointHoverBorderColor:'#fff',
        pointHoverBorderWidth:3
      };
      if(chart){ chart.data.labels = labels; chart.data.datasets = [ds]; chart.update(); return; }
      chart = new Chart(ctx, { 
        type:'line', 
        data:{ labels, datasets:[ds] }, 
        options:{
          responsive:true, 
          maintainAspectRatio:false,
          interaction:{intersect:false, mode:'index'},
          plugins:{ 
            legend:{
              display:true,
              position:'bottom',
              labels:{usePointStyle:true, pointStyle:'circle', padding:20, font:{size:14, weight:'600'}}
            },
            tooltip:{
              backgroundColor:'rgba(0,0,0,0.8)',
              titleColor:'#fff',
              bodyColor:'#fff',
              borderColor:'rgba(255,255,255,0.2)',
              borderWidth:1,
              cornerRadius:8,
              displayColors:true,
              titleFont:{size:14, weight:'bold'},
              bodyFont:{size:13}
            }
          },
          scales:{ 
            x:{
              grid:{color:'rgba(0,0,0,0.05)', drawBorder:false},
              ticks:{color:'#666', font:{size:12}}
            },
            y:{ 
              beginAtZero:true, 
              title:{display:true, text:'Lượng mưa (mm)', color:'#4dadea', font:{size:14, weight:'bold'}},
              grid:{color:'rgba(0,0,0,0.05)', drawBorder:false},
              ticks:{color:'#666', font:{size:12}}
            }
          },
          animation:{duration:2000, easing:'easeInOutQuart'},
          elements:{line:{borderJoinStyle:'round', borderCapStyle:'round'}}
        }
      });
    }

    async function load(){
      try{ const rows = await fetchRain24h(); renderChart(rows); }
      catch(e){ console.error(e); }
    }

    // --- PHẦN SỬA ĐỔI ---

    // 1. Hàm load giá trị đã lưu khi mở trang
    function loadSavedThreshold() {
      const saved = localStorage.getItem('rainThreshold_val');
      if (saved) {
        document.getElementById('rainThreshold').value = saved;
      }
    }

    async function setRainThreshold(){
      let v = Number(document.getElementById('rainThreshold').value || '0');
      
      // --- THÊM ĐOẠN KIỂM TRA NÀY ---
      if (v < 0) v = 0;
      if (v > 1000) {
        alert('Lượng mưa tối đa chỉ là 1000mm. Đã đặt lại về 1000.');
        v = 1000;
        document.getElementById('rainThreshold').value = 1000;
      }
      // ------------------------------

      try {
        const res = await fetch(`${API_BASE}/config/rain-threshold`, {
          method:'POST', headers:{'Content-Type':'application/json','x-api-token':getToken()},
          body: JSON.stringify({ threshold: v })
        });
        
        if(!res.ok){ throw new Error('HTTP '+res.status); }
        
        localStorage.setItem('rainThreshold_val', v);

        const msg = document.getElementById('saveMsg');
        msg.style.display = 'inline';
        setTimeout(()=> msg.style.display = 'none', 1500);
      } catch (e) { alert('Lưu ngưỡng thất bại'); }
    }

    // Khởi chạy
    load();
    loadSavedThreshold(); // Gọi hàm load lại giá trị cũ
    document.getElementById('btnSetThreshold').addEventListener('click', setRainThreshold);
  </script>