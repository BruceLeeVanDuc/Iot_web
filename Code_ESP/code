#include <WiFi.h>
#include <PubSubClient.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <DHT.h>

// =====================
// Config WiFi + Server + MQTT
// =====================
#define WIFI_SSID "BruceLeeDuc"
#define WIFI_PASSWORD "66662222"
#define SERVER_IP "172.20.10.3"  // IP mÃ¡y tÃ­nh cháº¡y server
#define SERVER_PORT 3000
#define API_TOKEN ""

// MQTT Config (cho LED control)
#define MQTT_SERVER "172.20.10.3"
#define MQTT_PORT 1883
#define MQTT_USER "levanduc"
#define MQTT_PASSWORD "0602"

// Äá»‹nh danh thiáº¿t bá»‹
#define DEVICE_ID "esp32-001"

// =====================
// Cáº¥u hÃ¬nh chÃ¢n
// =====================
#define DHTPIN 25
#define DHTTYPE DHT11
#define LED1 19
#define LED2 16
#define LED3 5
#define LIGHT_SENSOR_PIN 36
// LED cáº£nh bÃ¡o mÆ°a
#define RAIN_LED 21
// NgÆ°á»¡ng mÆ°a Ä‘á»ƒ NHáº¤P NHÃY LED (mm) â€” dáº£i mÆ°a 0..1000 (máº·c Ä‘á»‹nh)
float RAIN_THRESHOLD_MM = 100.0f;
// Chu ká»³ nháº¥p nhÃ¡y (ms)
#define RAIN_BLINK_INTERVAL_MS 300

DHT dht(DHTPIN, DHTTYPE);
WiFiClient espClient;
PubSubClient client(espClient);

unsigned long lastRead = 0;
unsigned long lastRainBlink = 0;
bool rainBlinkState = false;
float currentRainMm = 0.0; // giÃ¡ trá»‹ mÆ°a hiá»‡n táº¡i Ä‘á»ƒ Ä‘iá»u khiá»ƒn LED á»Ÿ vÃ²ng láº·p chÃ­nh
bool rainAlertActive = false;

// Tráº¡ng thÃ¡i LED (lÆ°u Ä‘á»ƒ khÃ´i phá»¥c sau khi reconnect)
String led1State = "OFF";
String led2State = "OFF";
String led3State = "OFF";


// =====================
// Káº¿t ná»‘i WiFi
// =====================
void setup_wifi() {
  Serial.print("Äang káº¿t ná»‘i WiFi: ");
  Serial.println(WIFI_SSID);
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi Ä‘Ã£ káº¿t ná»‘i, IP: ");
  Serial.println(WiFi.localIP());
}

// =====================
// HÃ m gá»­i dá»¯ liá»‡u sensor qua HTTP API + MQTT (thÃªm rain_mm)
// =====================
void sendSensorData(float temp, float humi, int light, float rainMm) {
  // 1. Gá»­i qua HTTP API (Ä‘á»ƒ lÆ°u vÃ o database)
  HTTPClient http;
  String url = "http://" + String(SERVER_IP) + ":" + String(SERVER_PORT) + "/api/telemetry";
  
  http.begin(url);
  http.addHeader("Content-Type", "application/json");
  http.addHeader("x-api-token", API_TOKEN);
  
  DynamicJsonDocument doc(1024);
  doc["deviceId"] = DEVICE_ID;
  doc["data"]["temp"] = temp;
  doc["data"]["humi"] = humi;
  doc["data"]["light"] = light;
  doc["data"]["rain_mm"] = rainMm;
  // KhÃ´ng gá»­i timestamp, Ä‘á»ƒ server tá»± táº¡o theo giá» Viá»‡t Nam
  
  String payload;
  serializeJson(doc, payload);
  
  Serial.println("ðŸ“¤ Gá»­i dá»¯ liá»‡u sensor qua HTTP API:");
  int httpResponseCode = http.POST(payload);
  
  if (httpResponseCode > 0) {
    Serial.printf("âœ… HTTP Response: %d\n", httpResponseCode);
  } else {
    Serial.printf("âŒ HTTP Error: %d\n", httpResponseCode);
  }
  http.end();
  
  // 2. Gá»­i qua MQTT (cho real-time display)
  char mqttPayload[192];
  snprintf(mqttPayload, sizeof(mqttPayload), "{\"temp\":%.1f,\"humi\":%.1f,\"light\":%d,\"rain_mm\":%.2f}", temp, humi, light, rainMm);
  client.publish("dataSensor", mqttPayload);
  Serial.println("ðŸ“¡ Gá»­i qua MQTT: dataSensor -> " + String(mqttPayload));
}

// =====================
// HÃ m Ä‘iá»u khiá»ƒn LED
// =====================
void setLED(int pin, String state, String topic) {
  digitalWrite(pin, state == "ON" ? HIGH : LOW);
  client.publish(topic.c_str(), state.c_str(), true); // retain = true
  
  // ðŸ”„ Pub ngÆ°á»£c láº¡i activity cho server
  String activityTopic = "activity/led" + String(pin == LED1 ? "1" : pin == LED2 ? "2" : "3");
  String activityPayload = "{\"device\":\"led" + String(pin == LED1 ? "1" : pin == LED2 ? "2" : "3") + 
                          "\",\"status\":\"" + state + "\",\"timestamp\":" + String(millis()) + "}";
  
  client.publish(activityTopic.c_str(), activityPayload.c_str());
  Serial.printf("ðŸ“¤ ÄÃ£ gá»­i activity: %s -> %s\n", activityTopic.c_str(), activityPayload.c_str());
}

// =====================
// Callback MQTT
// =====================
void callback(char* topic, byte* message, unsigned int length) {
  String msg;
  for (unsigned int i = 0; i < length; i++) msg += (char)message[i];
  msg.trim();

  Serial.printf("Nháº­n lá»‡nh [%s]: %s\n", topic, msg.c_str());

  if (String(topic) == "control/led1") {
    led1State = msg;
    setLED(LED1, led1State, "device/led1/state");
  } else if (String(topic) == "control/led2") {
    led2State = msg;
    setLED(LED2, led2State, "device/led2/state");
  } else if (String(topic) == "control/led3") {
    led3State = msg;
    setLED(LED3, led3State, "device/led3/state");
  } else if (String(topic) == "config/rain_threshold") {
    float v = msg.toFloat();
    if (v >= 0.0f && v <= 10000.0f) {
      RAIN_THRESHOLD_MM = v;
      Serial.printf("[CFG] Cáº­p nháº­t ngÆ°á»¡ng mÆ°a: %.2f mm\n", RAIN_THRESHOLD_MM);
    } else {
      Serial.printf("[CFG] GiÃ¡ trá»‹ ngÆ°á»¡ng khÃ´ng há»£p lá»‡: %s\n", msg.c_str());
    }
  }
}

// =====================
// Káº¿t ná»‘i láº¡i MQTT
// =====================
void reconnect() {
  while (!client.connected()) {
    Serial.print("Káº¿t ná»‘i MQTT...");
    // Táº¡o clientId duy nháº¥t tá»« MAC Ä‘á»ƒ trÃ¡nh trÃ¹ng khi cÃ³ nhiá»u thiáº¿t bá»‹
    String clientId = String("ESP32Client-") + WiFi.macAddress();
    if (client.connect(clientId.c_str(), MQTT_USER, MQTT_PASSWORD)) {
      Serial.println(" ThÃ nh cÃ´ng");
      client.subscribe("control/led1");
      client.subscribe("control/led2");
      client.subscribe("control/led3");
      // Subscribe nháº­n cáº¥u hÃ¬nh ngÆ°á»¡ng mÆ°a (retained)
      client.subscribe("config/rain_threshold");

      // ðŸ”„ KhÃ´i phá»¥c tráº¡ng thÃ¡i LED sau khi reconnect (khÃ´ng publish)
      digitalWrite(LED1, led1State == "ON" ? HIGH : LOW);
      digitalWrite(LED2, led2State == "ON" ? HIGH : LOW);
      digitalWrite(LED3, led3State == "ON" ? HIGH : LOW);

      // ðŸ›°ï¸ YÃªu cáº§u server gá»­i láº¡i tráº¡ng thÃ¡i cuá»‘i cÃ¹ng theo DB
      String getStateTopic = String("devices/") + DEVICE_ID + "/get_state";
      client.publish(getStateTopic.c_str(), "sync", false);

    } else {
      Serial.print(" Lá»—i, rc=");
      Serial.print(client.state());
      Serial.println(" -> Thá»­ láº¡i sau 5 giÃ¢y");
      // âš¡ Táº¯t LED khi máº¥t káº¿t ná»‘i
      digitalWrite(LED1, LOW);
      digitalWrite(LED2, LOW);
      digitalWrite(LED3, LOW);

      delay(5000);
    }
  }
}

// =====================
// Setup
// =====================
void setup() {
  Serial.begin(115200);
  dht.begin();

  pinMode(LED1, OUTPUT);
  pinMode(LED2, OUTPUT);
  pinMode(LED3, OUTPUT);
  pinMode(RAIN_LED, OUTPUT);
  digitalWrite(RAIN_LED, LOW);

  setup_wifi();
  client.setServer(MQTT_SERVER, MQTT_PORT);
  client.setCallback(callback);

  analogSetAttenuation(ADC_11db);

  // Seed random cho giáº£ láº­p mÆ°a
  randomSeed(esp_random());

  // Äá»£i WiFi sáºµn sÃ ng rá»“i yÃªu cáº§u Ä‘á»“ng bá»™ ngay láº§n Ä‘áº§u (sáº½ Ä‘Æ°á»£c gá»­i khi reconnect thÃ nh cÃ´ng)
}

// =====================
// Loop
// =====================
void loop() {
  if (!client.connected()) {
    reconnect();
  }
  client.loop();

  unsigned long now = millis();
  if (now - lastRead >= 5000) {  // Gá»­i má»—i 5 giÃ¢y
    lastRead = now;
    float h = dht.readHumidity();
    float t = dht.readTemperature();
    int lightValue = 4095 - analogRead(LIGHT_SENSOR_PIN); // Äáº£o ngÆ°á»£c: sÃ¡ng = giÃ¡ trá»‹ cao, tá»‘i = giÃ¡ trá»‹ tháº¥p
    // Giáº£ láº­p lÆ°á»£ng mÆ°a 0..1000 (mm). CÃ³ thá»ƒ Ä‘á»•i biÃªn Ä‘á»™ náº¿u cáº§n
    float rainMm = (float)random(0, 1001);
    currentRainMm = rainMm;               // cáº­p nháº­t giÃ¡ trá»‹ dÃ¹ng cho nháº¥p nhÃ¡y ngoÃ i block
    rainAlertActive = (currentRainMm > RAIN_THRESHOLD_MM);

    if (isnan(h) || isnan(t)) {
      Serial.println("Lá»—i Ä‘á»c DHT11!");
      return;
    }

    Serial.printf("Nhiá»‡t Ä‘á»™: %.1f Â°C, Äá»™ áº©m: %.1f %%, Ãnh sÃ¡ng: %d\n", t, h, lightValue);

    // Gá»­i dá»¯ liá»‡u
    sendSensorData(t, h, lightValue, rainMm);
  }

  // Khá»‘i nháº¥p nhÃ¡y LED cháº¡y má»—i vÃ²ng láº·p (khÃ´ng phá»¥ thuá»™c chu ká»³ 5s)
  if (rainAlertActive) {
    if (now - lastRainBlink >= RAIN_BLINK_INTERVAL_MS) {
      lastRainBlink = now;
      rainBlinkState = !rainBlinkState;
      digitalWrite(RAIN_LED, rainBlinkState ? HIGH : LOW);
    }
  } else {
    rainBlinkState = false;
    digitalWrite(RAIN_LED, LOW);
  }
}